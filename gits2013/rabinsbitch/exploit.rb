require 'socket'
require 'digest'
require 'shellwords'

def int2str(value, maxlen = 5)
	output = ""
	maxlen.times do |x|
		output += (value & 0xff).chr
		value >>= 8
	end
	output
end

def find_proof(salt)
	range = 0x10000000000
	range.times do |x|
		hash = Digest::SHA1.hexdigest(salt + int2str(x))
		if hash[-1] == 0xff and hash[-2] == 0xff and hash[-3] == 0xff and (hash[-4] & 3) == 3
			return int2str(x)
		end
	end 

	print "Cannot Found!"
	return nil
end

s = TCPSocket.open('localhost', 9955)
d = s.recv(0x1000)
salt = d[-16..-1]
puts "salt : #{salt}"
result = `./crack #{Shellwords.escape(salt)}`

exit() if result.index("Cannot find") 

result = result.scan(/../).map{|v| v.to_i(16).chr}.join
p result
puts "cracked : #{result}"

s.print(result)
s.print("\x01\x00")
s.print("\x03")

100.times do |x|
	output = s.recv(0x1000)
	p output
end
